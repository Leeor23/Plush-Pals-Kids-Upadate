<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory â€” Firestore (Single File)</title>
  <style>
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    button, input, select, textarea { font: inherit; }
  </style>
  <!-- React + ReactDOM (UMD) + Babel so we can write JSX in this single file -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <!-- Firebase (v9 modular) loaded as ES modules -->
  <script type="module">
    // --------- EDIT THESE TWO ----------
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBTaTOCwBSMZ_QPrD0ShBLxzQPqBmIcAJY",
      authDomain: "plush-pals-kids-inventory.firebaseapp.com",
      projectId: "plush-pals-kids-inventory",
      storageBucket: "plush-pals-kids-inventory.firebasestorage.app",
      messagingSenderId: "418872453672",
      appId: "1:418872453672:web:b3edd73802f1b98fd8a31d"
    };
    const COLLECTION = "items";
    // -----------------------------------

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, query, onSnapshot, addDoc, setDoc,
      doc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    try { await signInAnonymously(auth); } catch(e){ console.warn(e); }
    await new Promise(res => onAuthStateChanged(auth, () => res(), { onlyOnce:true }));

    // expose for the React app below
    window.__FB__ = { db, storage, COLLECTION };
  </script>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useRef, useState } = React;

    const fb = () => window.__FB__;

    // ---------- helpers ----------
    const cls = (...xs) => xs.filter(Boolean).join(" ");

    const titleCase = (s) => {
      s = String(s || "").trim().toLowerCase().replace(/\s+/g, " ");
      if (!s) return "";
      return s.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
    };

    // CSV helpers
    function toCSV(items) {
      const headers = ["barcode","plush","style","category","color","nameDrop","quantity","tieDye","notes","imageUrl"];
      const rows = items.map((it) => headers.map((h) => {
        let v = it[h];
        if (typeof v === "boolean") v = v ? "TRUE" : "FALSE";
        if (v == null) v = "";
        const s = String(v);
        return /[,"\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(","));
      return [headers.join(","), ...rows].join("\n");
    }
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (!lines.length) return [];
      const split = (line) => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
      const headers = split(lines[0]).map((h) => h.trim());
      const out = [];
      for (let i=1; i<lines.length; i++){
        const parts = split(lines[i]).map(p => {
          let v = p.trim();
          if (v.startsWith('"') && v.endsWith('"')) v = v.slice(1,-1).replace(/""/g,'"');
          return v;
        });
        const obj = {};
        headers.forEach((h,idx)=> obj[h] = parts[idx] ?? "");
        obj.quantity = Number(obj.quantity || 0);
        const t = String(obj.tieDye).toLowerCase();
        obj.tieDye = t==="true" || t==="yes" || t==="1";
        // normalize text fields
        obj.nameDrop = titleCase(obj.nameDrop);
        obj.color = titleCase(obj.color);
        obj.plush = titleCase(obj.plush);
        obj.style = titleCase(obj.style);
        obj.category = titleCase(obj.category || "T-shirt");
        return obj;
      }
      return out;
    }

    // ---------- UI ----------
    function Stat({label, value}) {
      return (
        <div className="rounded-2xl bg-white/60 backdrop-blur shadow-sm border border-gray-200 p-4">
          <div className="text-sm text-gray-500">{label}</div>
          <div className="mt-1 text-2xl font-semibold text-gray-900">{value}</div>
        </div>
      );
    }

    function App() {
      const [items, setItems] = useState([]);
      const [docByBarcode, setDocByBarcode] = useState({}); // barcode -> docId

      const [search, setSearch] = useState("");
      const [filters, setFilters] = useState({
        nameDrop: "All", category: "All", plush: "All", color: "All", tieDye: "All"
      });
      const [sort, setSort] = useState({ key: "barcode", dir: "asc" });
      const [modalOpen, setModalOpen] = useState(false);
      const [editing, setEditing] = useState(null);
      const [toast, setToast] = useState(null);
      const fileInputRef = useRef(null);

      // live subscribe
      useEffect(() => {
        const { db, COLLECTION } = fb();
        const coll = firebase.firestore ? collection(db, COLLECTION) : collection(db, COLLECTION);
        const unsub = onSnapshot(query(coll), snap => {
          const arr = [];
          const map = {};
          snap.forEach(d => {
            const data = d.data();
            arr.push(data);
            if (data.barcode) map[data.barcode] = d.id;
          });
          setItems(arr);
          setDocByBarcode(map);
        });
        return () => unsub();
      }, []);

      useEffect(() => { if(!toast) return; const t=setTimeout(()=>setToast(null),1800); return ()=>clearTimeout(t); }, [toast]);

      const distinct = useMemo(() => {
        const pick = (k) => Array.from(new Set(items.map(x => x[k]).filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
        return { nameDrop: pick("nameDrop"), category: pick("category"), plush: pick("plush"), color: pick("color") };
      }, [items]);

      const filtered = useMemo(() => {
        const q = search.trim().toLowerCase();
        const pass = (it) => {
          if (filters.nameDrop !== "All" && it.nameDrop !== filters.nameDrop) return false;
          if (filters.category !== "All" && it.category !== filters.category) return false;
          if (filters.plush !== "All" && it.plush !== filters.plush) return false;
          if (filters.color !== "All" && it.color !== filters.color) return false;
          if (filters.tieDye !== "All") {
            const want = filters.tieDye === "Yes";
            if (!!it.tieDye !== want) return false;
          }
          if (!q) return true;
          const hay = `${it.barcode} ${it.plush} ${it.style} ${it.category} ${it.color} ${it.nameDrop} ${it.notes}`.toLowerCase();
          return hay.includes(q);
        };
        const out = items.filter(pass);
        const dir = (sort.dir === "asc") ? 1 : -1;
        const key = sort.key;
        out.sort((a,b) => key==="quantity"
          ? ((+a[key]||0) - (+b[key]||0)) * dir
          : String(a[key]||"").localeCompare(String(b[key]||"")) * dir
        );
        return out;
      }, [items, search, filters, sort]);

      // totals
      const totalSKUs = items.length;
      const totalUnits = useMemo(() => items.reduce((m,it)=>m+(Number(it.quantity)||0),0), [items]);
      const filteredSKUs = filtered.length;
      const unitsInSelectedNameDrop = useMemo(() => {
        if (filters.nameDrop === "All") return 0;
        return items.filter(x=>x.nameDrop===filters.nameDrop).reduce((m,it)=>m+(Number(it.quantity)||0),0);
      }, [items, filters.nameDrop]);

      // CRUD
      async function upsertItem(payload) {
        // normalize text
        payload.nameDrop = titleCase(payload.nameDrop);
        payload.color = titleCase(payload.color);
        payload.plush = titleCase(payload.plush);
        payload.style = titleCase(payload.style);
        payload.category = titleCase(payload.category || "T-shirt");

        const { db, COLLECTION } = fb();
        const existingId = docByBarcode[payload.barcode];
        if (existingId) {
          await setDoc(doc(db, COLLECTION, existingId), { ...payload, _ts: serverTimestamp() });
        } else {
          await addDoc(collection(db, COLLECTION), { ...payload, _ts: serverTimestamp() });
        }
      }
      async function removeItem(barcode) {
        const { db, COLLECTION } = fb();
        const id = docByBarcode[barcode];
        if (id) await deleteDoc(doc(db, COLLECTION, id));
      }

      // image upload
      async function handleImageFile(e) {
        const file = e.target.files?.[0]; if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
          const ok = confirm("This image is larger than 2 MB. Use anyway?");
          if (!ok) { e.target.value=''; return; }
        }
        const safe = (editing?.data.barcode || "img") + "_" + Date.now() + "_" + (file.name || "file");
        const { storage } = fb();
        const r = sRef(storage, `images/${safe}`);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);
        setEditing(prev => prev ? ({ ...prev, data: { ...prev.data, imageUrl: url } }) : prev);
      }

      function openNew() {
        setEditing({ mode: "create", data: { barcode:"", plush:"", style:"", category:"T-shirt", color:"", nameDrop:"", quantity:0, tieDye:false, notes:"", imageUrl:"" } });
        setModalOpen(true);
      }
      function openEdit(it) { setEditing({ mode:"edit", data:{...it} }); setModalOpen(true); }
      function remove(it) { if (!confirm(`Delete ${it.barcode} â€” ${it.plush} (${it.nameDrop})?`)) return; void removeItem(it.barcode); }

      async function onSubmitForm(e) {
        e.preventDefault();
        const form = new FormData(e.currentTarget);
        const d = Object.fromEntries(form.entries());
        const payload = {
          barcode: String(d.barcode||"").trim(),
          plush: String(d.plush||"").trim(),
          style: String(d.style||"").trim(),
          category: String(d.category||"T-shirt"),
          color: String(d.color||"").trim(),
          nameDrop: String(d.nameDrop||"").trim(),
          quantity: Number(d.quantity||0),
          tieDye: d.tieDye === "on",
          notes: String(d.notes||"").trim(),
          imageUrl: String(d.imageUrl||"").trim()
        };
        if (!payload.barcode) return alert("Barcode is required");
        if (!payload.plush) return alert("Plush is required");
        if (!payload.nameDrop) return alert("Name Drop is required");
        if (!Number.isFinite(payload.quantity) || payload.quantity < 0) return alert("Quantity must be 0 or more");

        await upsertItem(payload);
        setModalOpen(false); setEditing(null); setToast(editing?.mode==="edit"?"Item updated":"Item added");
      }

      // CSV import/export
      function exportCSV() {
        const blob = new Blob([toCSV(items)], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.href = url; link.download = `inventory-${new Date().toISOString().slice(0,10)}.csv`; link.style.display = "none";
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
      function importCSV(evt) {
        const file = evt.target.files?.[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const parsed = parseCSV(String(reader.result||"")); if (!parsed.length) return alert("No rows found in CSV");
            for (const row of parsed) { if (!row.barcode) continue; await upsertItem(row); }
            setToast("CSV imported");
          } catch (e) { console.error(e); alert("Failed to import CSV"); }
          finally { evt.target.value = ""; }
        };
        reader.readAsText(file);
      }

      return (
        <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white text-gray-900">
          {/* Header */}
          <header className="sticky top-0 z-30 bg-gradient-to-b from-white to-white/80 backdrop-blur border-b border-gray-200">
            <div className="mx-auto max-w-7xl px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
              <div>
                <h1 className="text-2xl font-bold">Inventory â€” Firestore</h1>
                <p className="text-sm text-gray-600">Realtime across devices (anonymous auth).</p>
              </div>
              <div className="flex flex-wrap gap-2 items-center">
                <button className="rounded-xl bg-gray-900 text-white px-4 py-2 hover:bg-black" onClick={openNew}>Add Item</button>
                <button className="rounded-xl bg-white border px-4 py-2 hover:bg-gray-50" onClick={exportCSV}>Export CSV</button>
                <button className="rounded-xl bg-white border px-4 py-2 hover:bg-gray-50" onClick={() => fileInputRef.current?.click()}>Import CSV</button>
                <input ref={fileInputRef} type="file" accept=".csv,text/csv" className="hidden" onChange={importCSV} />
              </div>
            </div>
          </header>

          {/* Filters */}
          <section className="mx-auto max-w-7xl px-4 pt-4 pb-2">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div className="md:col-span-2">
                <label className="block text-sm text-gray-600 mb-1">Search</label>
                <input value={search} onChange={(e)=>setSearch(e.target.value)} placeholder="Search barcode, plush, color, name drop, notesâ€¦" className="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900" />
              </div>
              <div>
                <label className="block text-sm text-gray-600 mb-1">Name Drop</label>
                <select value={filters.nameDrop} onChange={(e)=>setFilters({...filters, nameDrop:e.target.value})} className="w-full rounded-xl border px-3 py-2">
                  <option>All</option>{distinct.nameDrop.map(v => (<option key={v}>{v}</option>))}
                </select>
              </div>
              <div className="grid grid-cols-3 gap-3 md:grid-cols-3 md:col-span-1">
                <div>
                  <label className="block text-sm text-gray-600 mb-1">Category</label>
                  <select value={filters.category} onChange={(e)=>setFilters({...filters, category:e.target.value})} className="w-full rounded-xl border px-3 py-2">
                    <option>All</option><option>T-shirt</option><option>Dress</option><option>Onesie</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm text-gray-600 mb-1">Plush</label>
                  <select value={filters.plush} onChange={(e)=>setFilters({...filters, plush:e.target.value})} className="w-full rounded-xl border px-3 py-2">
                    <option>All</option>{distinct.plush.map(v => (<option key={v}>{v}</option>))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm text-gray-600 mb-1">Color</label>
                  <select value={filters.color} onChange={(e)=>setFilters({...filters, color:e.target.value})} className="w-full rounded-xl border px-3 py-2">
                    <option>All</option>{distinct.color.map(v => (<option key={v}>{v}</option>))}
                  </select>
                </div>
              </div>
              <div className="md:col-span-4 -mt-2 flex items-center gap-3">
                <label className="text-sm text-gray-600">Tie-Dye</label>
                <div className="flex gap-2">
                  {["All","Yes","No"].map(v => (
                    <button key={v} onClick={()=>setFilters({...filters, tieDye:v})} className={cls("px-3 py-1 rounded-full border", filters.tieDye===v ? "bg-gray-900 text-white border-gray-900" : "bg-white hover:bg-gray-50")}>{v}</button>
                  ))}
                </div>
                <div className="ml-auto text-sm text-gray-500">{filtered.length} / {items.length} rows</div>
              </div>
            </div>
          </section>

          {/* Stat cards */}
          <section className="mx-auto max-w-7xl px-4 pb-4">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <Stat label="Total SKUs" value={totalSKUs} />
              <Stat label="Total Units" value={totalUnits} />
              <Stat label="Filtered SKUs" value={filteredSKUs} />
              <Stat label={filters.nameDrop!=="All" ? `Units in ${filters.nameDrop}` : "Units in (select Name Drop)"} value={unitsInSelectedNameDrop} />
            </div>
          </section>

          {/* Table */}
          <section className="mx-auto max-w-7xl px-4 pb-10">
            <div className="overflow-auto rounded-2xl border border-gray-200 bg-white">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="bg-gray-50 text-left">
                    {["#","Barcode","Plush","Style","Category","Color","Name Drop","Qty","Tie-Dye","Notes","Image","Actions"].map(h => (
                      <th key={h} className="px-3 py-2 font-medium text-gray-700 border-b">{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {filtered.map((it, idx) => (
                    <tr key={it.barcode || idx} className="border-b last:border-0 hover:bg-gray-50/60">
                      <td className="px-3 py-2 text-xs text-gray-500">#{idx+1}</td>
                      <td className="px-3 py-2 font-mono text-xs">{it.barcode}</td>
                      <td className="px-3 py-2">{it.plush}</td>
                      <td className="px-3 py-2">{it.style}</td>
                      <td className="px-3 py-2">{it.category}</td>
                      <td className="px-3 py-2">{it.color}</td>
                      <td className="px-3 py-2">{it.nameDrop}</td>
                      <td className="px-3 py-2 text-right tabular-nums">{it.quantity}</td>
                      <td className="px-3 py-2">{it.tieDye ? "Yes" : "No"}</td>
                      <td className="px-3 py-2 max-w-[24ch] truncate" title={it.notes}>{it.notes}</td>
                      <td className="px-3 py-2">
                        {it.imageUrl ? <img src={it.imageUrl} className="h-10 w-10 object-cover rounded-lg" /> : <span className="text-gray-400">â€”</span>}
                      </td>
                      <td className="px-3 py-2">
                        <div className="flex gap-2">
                          <button className="rounded-lg border px-2 py-1 hover:bg-gray-50" onClick={()=>openEdit(it)}>Edit</button>
                          <button className="rounded-lg border px-2 py-1 hover:bg-red-50 text-red-600 border-red-200" onClick={()=>remove(it)}>Delete</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                  {!filtered.length && (
                    <tr><td colSpan={12} className="px-3 py-10 text-center text-gray-500">No items match your search/filters.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </section>

          {/* Modal */}
          {modalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center">
              <div className="absolute inset-0 bg-black/30" onClick={()=>setModalOpen(false)} />
              <div className="relative z-10 w-[min(720px,92vw)] max-h-[90vh] overflow-auto rounded-2xl bg-white shadow-xl border border-gray-200 p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">{editing?.mode==="edit" ? `Edit ${editing?.data?.barcode}` : "Add New Item"}</h3>
                  <button className="px-2 py-1 text-gray-500 hover:text-gray-700" onClick={()=>setModalOpen(false)} aria-label="Close">âœ•</button>
                </div>
                <form onSubmit={onSubmitForm} className="space-y-3">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div><label className="block text-sm text-gray-600 mb-1">Barcode *</label><input name="barcode" required defaultValue={editing?.data?.barcode||""} className="w-full rounded-xl border px-3 py-2" /></div>
                    <div><label className="block text-sm text-gray-600 mb-1">Plush *</label><input name="plush" defaultValue={editing?.data?.plush||""} className="w-full rounded-xl border px-3 py-2" placeholder="Dolphin, Turtle, Mermaidâ€¦" /></div>
                    <div><label className="block text-sm text-gray-600 mb-1">Style</label><input name="style" defaultValue={editing?.data?.style||""} className="w-full rounded-xl border px-3 py-2" placeholder="Classic, Tie-Dye, etc." /></div>
                    <div><label className="block text-sm text-gray-600 mb-1">Category</label>
                      <select name="category" defaultValue={editing?.data?.category||"T-shirt"} className="w-full rounded-xl border px-3 py-2">
                        <option>T-shirt</option><option>Dress</option><option>Onesie</option>
                      </select>
                    </div>
                    <div><label className="block text-sm text-gray-600 mb-1">Color</label><input name="color" defaultValue={editing?.data?.color||""} className="w-full rounded-xl border px-3 py-2" placeholder="Blue, Greenâ€¦" /></div>
                    <div><label className="block text-sm text-gray-600 mb-1">Name Drop *</label><input name="nameDrop" defaultValue={editing?.data?.nameDrop||""} className="w-full rounded-xl border px-3 py-2" placeholder="Key West, Miami Beachâ€¦" /></div>
                    <div><label className="block text-sm text-gray-600 mb-1">Quantity *</label><input name="quantity" type="number" min={0} step={1} defaultValue={editing?.data?.quantity ?? 0} className="w-full rounded-xl border px-3 py-2" /></div>
                    <div className="flex items-center gap-2 mt-6">
                      <input id="tieDye" name="tieDye" type="checkbox" defaultChecked={!!editing?.data?.tieDye} className="h-4 w-4" />
                      <label htmlFor="tieDye" className="text-sm">Tie-Dye</label>
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm text-gray-600 mb-1">Image URL (or upload)</label>
                      <input name="imageUrl" defaultValue={editing?.data?.imageUrl||""} className="w-full rounded-xl border px-3 py-2" placeholder="https://â€¦" />
                      <div className="mt-2"><input type="file" accept="image/*" onChange={handleImageFile} /></div>
                    </div>
                    <div className="md:col-span-2"><label className="block text-sm text-gray-600 mb-1">Notes</label><textarea name="notes" rows={3} defaultValue={editing?.data?.notes||""} className="w-full rounded-xl border px-3 py-2" /></div>
                  </div>
                  <div className="flex justify-end gap-2 pt-2">
                    <button type="button" onClick={()=>setModalOpen(false)} className="rounded-xl border px-4 py-2 bg-white hover:bg-gray-50">Cancel</button>
                    <button type="submit" className="rounded-xl bg-gray-900 text-white px-4 py-2 hover:bg-black">{editing?.mode==="edit" ? "Save Changes" : "Add Item"}</button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {toast && (
            <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-50">
              <div className="rounded-full bg-gray-900 text-white px-4 py-2 shadow-lg">{toast}</div>
            </div>
          )}

          <footer className="mx-auto max-w-7xl px-4 pb-10 text-xs text-gray-500">
            <div>Live Firestore collection: <b>{fb().COLLECTION}</b>. Fields: barcode, plush, style, category, color, nameDrop, quantity, tieDye, notes, imageUrl.</div>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
